<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>About - CxN Clan</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/about.css">
</head>
<body>
    <nav id="main-nav"></nav>
    <div class="container">
        <header class="about-hero">
            <h1 class="clan-name">About CxN</h1>
        </header>

        <section class="clan-stats" aria-label="Clan statistics">
            <div class="clan-stat">
                <div>
                    <span class="clan-stat-label">Might</span>
                    <div id="stat-might" class="clan-stat-value formatted">Loading...</div>
                </div>
            </div>
            <div class="clan-stat">
                <div>
                    <span class="clan-stat-label">Wealth</span>
                    <div id="stat-wealth" class="clan-stat-value formatted">Loading...</div>
                </div>
            </div>
            <div class="clan-stat">
                <div>
                    <span class="clan-stat-label">Kingdom</span>
                    <div class="clan-stat-value">277</div>
                </div>
            </div>
            <div class="clan-stat clan-capital">
                <div>
                    <span class="clan-stat-label">Clan Capital</span>
                    <div class="clan-stat-value">K:277 X:286 Y:902</div>
                </div>
            </div>
        </section>

        <section class="hierarchy-section" aria-labelledby="hierarchy-heading">
            <h2 id="hierarchy-heading" class="visually-hidden">Clan leadership hierarchy</h2>

            <h3 class="hierarchy-title leader">Leader</h3>
            <div id="members-leader" class="members-list">
                <span class="member-tag">Loading...</span>
            </div>

            <h3 class="hierarchy-title superiors">Superiors</h3>
            <div id="members-superiors" class="members-list">
                <span class="member-tag">Loading...</span>
            </div>

            <h3 class="hierarchy-title officers">Officers</h3>
            <div id="members-officers" class="members-list">
                <span class="member-tag">Loading...</span>
            </div>

            <h3 class="hierarchy-title veterans">Veterans</h3>
            <div id="members-veterans" class="members-list">
                <span class="member-tag">Loading...</span>
            </div>

            <h3 class="hierarchy-title soldiers">Soldiers</h3>
            <div id="members-soldiers" class="members-list">
                <span class="member-tag">Loading...</span>
            </div>
        </section>
    </div>
    <footer id="main-footer"></footer>
    <script src="../js/nav.js"></script>
    <script>
        // Load clan members from JSON and render them
        (function() {
            'use strict';
            
            function createMemberTag(member) {
                const span = document.createElement('span');
                const hasBadges = member.badges && member.badges.length > 0;
                
                if (hasBadges) {
                    span.className = 'member-tag has-badge';
                    span.setAttribute('tabindex', '0');
                    span.innerHTML = `
                        ${member.name}
                        <span class="member-badge-icon" aria-hidden="true">â˜…</span>
                        <span class="badge-tooltip">${member.badges.join(', ')}</span>
                    `;
                } else {
                    span.className = 'member-tag';
                    span.textContent = member.name;
                }
                
                return span;
            }
            
            function renderMembers(members, containerId) {
                const container = document.getElementById(containerId);
                if (!container || !members) return;
                
                container.innerHTML = '';
                members.forEach(member => {
                    container.appendChild(createMemberTag(member));
                });
            }
            
            function setupBadgeToggles() {
                document.querySelectorAll('.member-tag.has-badge').forEach(function (el) {
                    el.addEventListener('click', function (e) {
                        e.preventDefault();
                        var open = this.getAttribute('data-badge-open') === 'true';
                        document.querySelectorAll('.member-tag.has-badge').forEach(function (o) {
                            o.classList.remove('badge-open');
                            o.setAttribute('data-badge-open', 'false');
                        });
                        if (!open) {
                            this.classList.add('badge-open');
                            this.setAttribute('data-badge-open', 'true');
                        }
                    });
                });
            }
            
            async function loadClanMembers() {
                try {
                    // First try to load from localStorage (admin-managed data)
                    const MEMBERS_KEY = 'cxn_clan_members';
                    let data = null;
                    
                    try {
                        const stored = localStorage.getItem(MEMBERS_KEY);
                        if (stored) {
                            data = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.log('No localStorage data, falling back to file');
                    }
                    
                    // Fall back to JSON file if no localStorage data
                    if (!data) {
                        const response = await fetch('../data/clan_members.json');
                        if (!response.ok) throw new Error('Failed to load clan members');
                        data = await response.json();
                    }
                    
                    renderMembers(data.leader, 'members-leader');
                    renderMembers(data.superiors, 'members-superiors');
                    renderMembers(data.officers, 'members-officers');
                    renderMembers(data.veterans, 'members-veterans');
                    renderMembers(data.soldiers, 'members-soldiers');
                    
                    // Setup badge toggles after rendering
                    setupBadgeToggles();
                } catch (e) {
                    console.error('Error loading clan members:', e);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadClanMembers);
            } else {
                loadClanMembers();
            }
        })();
        
        // Close badge tooltips when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.member-tag.has-badge')) {
                document.querySelectorAll('.member-tag.has-badge').forEach(function (o) {
                    o.classList.remove('badge-open');
                    o.setAttribute('data-badge-open', 'false');
                });
            }
        });
    </script>
    <script>
        // Load clan stats dynamically
        (function() {
            'use strict';
            
            const STATS_KEY = 'cxn_clan_stats';
            
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            function getStats() {
                try {
                    const data = localStorage.getItem(STATS_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    return null;
                }
            }
            
            async function loadStatsFromFile() {
                try {
                    const response = await fetch('../data/clan_stats.json');
                    if (!response.ok) throw new Error('Failed to load');
                    return await response.json();
                } catch (e) {
                    console.error('Error loading clan stats:', e);
                    return { might: 0, wealth: 0 };
                }
            }
            
            async function init() {
                let stats = getStats();
                
                if (!stats) {
                    stats = await loadStatsFromFile();
                    if (stats) {
                        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
                    }
                }
                
                const mightEl = document.getElementById('stat-might');
                const wealthEl = document.getElementById('stat-wealth');
                
                if (mightEl && stats.might) {
                    mightEl.textContent = formatNumber(stats.might);
                }
                if (wealthEl && stats.wealth) {
                    wealthEl.textContent = formatNumber(stats.wealth);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
